<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST - Airsoft Tactical</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #000; color: #00ff00; }
        
        .setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; justify-content: center; align-items: center;
            z-index: 10000;
        }
        
        .setup-box {
            background: #1a1a1a; padding: 30px; border-radius: 15px;
            border: 2px solid #00ff00; text-align: center; max-width: 90%;
        }
        
        .setup-box h1 { margin-bottom: 20px; color: #00ff00; }
        .setup-box input {
            width: 100%; padding: 12px; margin: 10px 0;
            background: #333; border: 2px solid #00ff00; color: #00ff00;
            border-radius: 8px; font-size: 16px;
        }
        
        .setup-box button {
            padding: 15px 30px; background: #00ff00; color: #000;
            border: none; border-radius: 8px; cursor: pointer;
            font-weight: bold; font-size: 16px; margin-top: 15px;
        }
        
        .hidden { display: none !important; }
        
        #map { width: 100%; height: 100vh; }
        
        .status {
            position: fixed; top: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.9); padding: 10px; border-radius: 8px;
            border: 1px solid #00ff00; z-index: 1000;
            font-size: 12px;
        }
        
        .controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; z-index: 1000;
        }
        
        .btn {
            padding: 10px 15px; background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00ff00; color: #00ff00; border-radius: 8px;
            cursor: pointer; font-weight: bold;
        }
        
        .btn:hover { background: rgba(0, 255, 0, 0.2); }
        .btn.active { background: rgba(255, 0, 0, 0.8); color: #fff; }
        
        .notification {
            position: fixed; top: 60px; right: 10px; z-index: 2000;
            background: rgba(0, 255, 0, 0.9); color: #000; padding: 10px 20px;
            border-radius: 8px; font-weight: bold;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .sensor-panel {
            position: fixed; bottom: 80px; right: 10px;
            background: rgba(0, 0, 0, 0.9); border: 1px solid #00ff00;
            border-radius: 10px; padding: 15px; z-index: 1000;
            display: none; min-width: 200px; max-height: 300px; overflow-y: auto;
        }
        
        .sensor-panel.show { display: block; }
        
        .sensor-panel h3 {
            color: #00ff00; margin: 0 0 10px 0; font-size: 14px;
        }
        
        .sensor-item {
            background: rgba(0, 255, 0, 0.1); border: 1px solid #00ff00;
            border-radius: 5px; padding: 8px; margin: 5px 0;
            cursor: pointer; display: flex; justify-content: space-between;
            font-size: 12px;
        }
        
        .sensor-item:hover { background: rgba(0, 255, 0, 0.2); }
        
        .sensor-item.triggered {
            background: rgba(255, 0, 0, 0.3); border-color: #ff0000;
            animation: sensorAlert 1s infinite;
        }
        
        @keyframes sensorAlert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .sensor-marker {
            width: 30px; height: 30px; background: #00ff00;
            border: 3px solid #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
        }
        
        .sensor-marker.triggered {
            background: #ff0000; animation: sensorPulse 1s infinite;
        }
        
        @keyframes sensorPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
    </style>
</head>
<body>
    <div class="setup-screen" id="setupScreen">
        <div class="setup-box">
            <h1>üéØ TEST - AIRSOFT TACTICAL</h1>
            <p style="color: #888; font-size: 12px; margin-bottom: 15px;">Version de test avec capteurs</p>
            <input type="text" id="teamCode" placeholder="Code √©quipe (ex: A)" maxlength="15" value="A">
            <input type="text" id="playerName" placeholder="Votre nom (ex: TEST)" maxlength="10" value="TEST">
            <button onclick="startApp()">üöÄ D√âMARRER TEST</button>
        </div>
    </div>

    <div id="map" class="hidden"></div>

    <div class="status hidden" id="gameStatus">
        <div id="firebaseStatus">üî• OFF</div>
        <div id="gpsStatus">üìç OFF</div>
        <div id="teamInfo">√âquipe: -</div>
    </div>

    <div class="controls hidden" id="gameControls">
        <button class="btn" onclick="centerMap()">üìç Centrer</button>
        <button class="btn" id="sensorBtn" onclick="toggleSensorMode()">üì° Capteurs</button>
        <button class="btn" onclick="testSensor()">üîî Test</button>
        <button class="btn" onclick="showDebug()">üêõ Debug</button>
    </div>

    <div class="sensor-panel" id="sensorPanel">
        <h3>üì° CAPTEURS</h3>
        <div id="sensorList">Chargement...</div>
        <button class="btn" onclick="addSensor()" style="width: 100%; margin-top: 10px;">
            ‚ûï Ajouter capteur
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "OninF0hGCgA3fJ600rPOWgo8qrBr222ijsprPfWT",
            authDomain: "airsoft-tactical.firebaseapp.com",
            databaseURL: "https://airsoft-tactical-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "airsoft-tactical",
            storageBucket: "airsoft-tactical.appspot.com",
            messagingSenderId: "Admin01",
            appId: "001"
        };

        // √âtat global
        window.appState = {
            map: null,
            firebase: null,
            db: null,
            teamCode: null,
            playerName: null,
            position: { lat: 48.8566, lng: 2.3522 },
            sensors: {},
            sensorMode: false,
            isConnected: false
        };

        // D√©marrage de l'application
        window.startApp = function() {
            const teamCode = document.getElementById('teamCode').value.trim().toUpperCase();
            const playerName = document.getElementById('playerName').value.trim().toUpperCase();

            if (!teamCode || !playerName) {
                alert('Remplissez tous les champs !');
                return;
            }

            console.log('üöÄ D√©marrage avec:', { teamCode, playerName });

            window.appState.teamCode = teamCode;
            window.appState.playerName = playerName;

            // Masquer setup
            document.getElementById('setupScreen').classList.add('hidden');
            
            // Afficher carte et contr√¥les
            document.getElementById('map').classList.remove('hidden');
            document.getElementById('gameStatus').classList.remove('hidden');
            document.getElementById('gameControls').classList.remove('hidden');

            // Mise √† jour info √©quipe
            document.getElementById('teamInfo').textContent = `√âquipe: ${teamCode} - ${playerName}`;

            // Initialiser Firebase
            initFirebase();

            // Initialiser la carte
            initMap();

            notify('‚úÖ Application d√©marr√©e !');
        };

        function initFirebase() {
            console.log('üî• Initialisation Firebase...');
            
            try {
                window.appState.firebase = initializeApp(firebaseConfig);
                window.appState.db = getDatabase(window.appState.firebase);
                
                // V√©rifier connexion
                const connRef = ref(window.appState.db, '.info/connected');
                onValue(connRef, (snap) => {
                    window.appState.isConnected = snap.val() === true;
                    document.getElementById('firebaseStatus').textContent = 
                        window.appState.isConnected ? 'üî• ON' : 'üî• OFF';
                    
                    if (window.appState.isConnected) {
                        console.log('‚úÖ Firebase connect√© !');
                        setupSensorListener();
                    }
                });
            } catch (error) {
                console.error('‚ùå Erreur Firebase:', error);
                notify('‚ùå Erreur Firebase');
            }
        }

        function setupSensorListener() {
            if (!window.appState.db || !window.appState.teamCode) return;

            console.log('üëÇ √âcoute des capteurs pour:', window.appState.teamCode);
            
            const sensorsRef = ref(window.appState.db, `sensors/${window.appState.teamCode}`);
            
            onValue(sensorsRef, (snapshot) => {
                const data = snapshot.val();
                console.log('üì° Capteurs re√ßus:', data);
                updateSensors(data);
            });
        }

        function initMap() {
            console.log('üó∫Ô∏è Initialisation carte...');
            
            window.appState.map = L.map('map', {
                center: [window.appState.position.lat, window.appState.position.lng],
                zoom: 15,
                zoomControl: false
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(window.appState.map);

            // Marqueur joueur
            L.marker([window.appState.position.lat, window.appState.position.lng])
                .addTo(window.appState.map)
                .bindPopup('üë§ Vous √™tes ici');

            document.getElementById('gpsStatus').textContent = 'üìç OK';
            
            notify('üó∫Ô∏è Carte charg√©e !');
        }

        function updateSensors(data) {
            console.log('üîÑ Mise √† jour capteurs');
            
            const list = document.getElementById('sensorList');
            
            // Effacer les anciens marqueurs
            Object.keys(window.appState.sensors).forEach(id => {
                if (!data || !data[id]) {
                    if (window.appState.sensors[id].marker) {
                        window.appState.map.removeLayer(window.appState.sensors[id].marker);
                    }
                    delete window.appState.sensors[id];
                }
            });

            if (!data) {
                list.innerHTML = '<div style="color: #888; font-size: 11px;">Aucun capteur</div>';
                return;
            }

            list.innerHTML = '';
            let count = 0;

            Object.keys(data).forEach(id => {
                const sensor = data[id];
                
                // V√©rifier position
                if (!sensor.position || !sensor.position.lat || !sensor.position.lng) {
                    console.log(`‚ö†Ô∏è Capteur ${id} sans position`);
                    return;
                }

                count++;

                // Cr√©er ou mettre √† jour
                if (!window.appState.sensors[id]) {
                    createSensorMarker(id, sensor);
                } else {
                    updateSensorMarker(id, sensor);
                }

                // Ajouter √† la liste
                const item = document.createElement('div');
                item.className = 'sensor-item';
                if (sensor.status === 'triggered') {
                    item.classList.add('triggered');
                }
                item.innerHTML = `
                    <span>${sensor.name || id}</span>
                    <span>${sensor.status === 'triggered' ? 'üö®' : '‚úÖ'}</span>
                `;
                item.onclick = () => {
                    if (window.appState.sensors[id] && window.appState.sensors[id].marker) {
                        const marker = window.appState.sensors[id].marker;
                        window.appState.map.setView(marker.getLatLng(), 18);
                        marker.openPopup();
                    }
                };
                list.appendChild(item);
            });

            console.log(`‚úÖ ${count} capteurs affich√©s`);
            
            if (count === 0) {
                list.innerHTML = '<div style="color: #888; font-size: 11px;">Aucun capteur avec position</div>';
            }
        }

        function createSensorMarker(id, sensor) {
            console.log('‚ûï Cr√©ation marqueur:', id, sensor.position);

            const isTriggered = sensor.status === 'triggered';
            
            const icon = L.divIcon({
                className: 'sensor-marker-div',
                html: `<div class="sensor-marker ${isTriggered ? 'triggered' : ''}">üì°</div>
                       <div style="background: rgba(0,0,0,0.8); color: ${isTriggered ? '#ff0000' : '#00ff00'}; 
                                   padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">
                           ${sensor.name || id}
                       </div>`,
                iconSize: [40, 50],
                iconAnchor: [20, 25]
            });

            const marker = L.marker([sensor.position.lat, sensor.position.lng], { icon })
                .addTo(window.appState.map);

            marker.bindPopup(`
                <div style="text-align: center;">
                    <b>üì° ${sensor.name || id}</b><br>
                    <small>√âtat: ${isTriggered ? 'üö® D√âCLENCH√â' : '‚úÖ Actif'}</small><br>
                    ${sensor.placedBy ? `<small>Par: ${sensor.placedBy}</small><br>` : ''}
                    <button onclick="testSensorById('${id}')" style="margin: 5px; padding: 5px 10px; background: #00ff00; border: none; border-radius: 3px; cursor: pointer;">
                        üîî Tester
                    </button>
                    <button onclick="removeSensorById('${id}')" style="margin: 5px; padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 3px; cursor: pointer;">
                        ‚ùå Retirer
                    </button>
                </div>
            `);

            window.appState.sensors[id] = { data: sensor, marker: marker };
        }

        function updateSensorMarker(id, sensor) {
            const marker = window.appState.sensors[id].marker;
            if (!marker) return;

            const isTriggered = sensor.status === 'triggered';
            
            const icon = L.divIcon({
                className: 'sensor-marker-div',
                html: `<div class="sensor-marker ${isTriggered ? 'triggered' : ''}">üì°</div>
                       <div style="background: rgba(0,0,0,0.8); color: ${isTriggered ? '#ff0000' : '#00ff00'}; 
                                   padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">
                           ${sensor.name || id}
                       </div>`,
                iconSize: [40, 50],
                iconAnchor: [20, 25]
            });

            marker.setIcon(icon);
            window.appState.sensors[id].data = sensor;

            if (isTriggered && !window.appState.sensors[id].alerted) {
                window.appState.sensors[id].alerted = true;
                notify(`üö® ${sensor.name || id} d√©clench√© !`);
                setTimeout(() => {
                    if (window.appState.sensors[id]) {
                        window.appState.sensors[id].alerted = false;
                    }
                }, 30000);
            }
        }

        window.toggleSensorMode = function() {
            window.appState.sensorMode = !window.appState.sensorMode;
            const btn = document.getElementById('sensorBtn');
            const panel = document.getElementById('sensorPanel');
            
            if (window.appState.sensorMode) {
                btn.classList.add('active');
                panel.classList.add('show');
                notify('üì° Panneau capteurs ouvert');
            } else {
                btn.classList.remove('active');
                panel.classList.remove('show');
            }
        };

        window.addSensor = function() {
            const panel = document.getElementById('sensorPanel');
            panel.classList.remove('show');
            
            window.appState.map.getContainer().style.cursor = 'crosshair';
            notify('üìç Cliquez pour placer le capteur');

            const handler = (e) => {
                window.appState.map.off('click', handler);
                window.appState.map.getContainer().style.cursor = '';

                const name = prompt('Nom du capteur:', 'SENSOR_' + Date.now().toString().slice(-4));
                if (!name) {
                    notify('Placement annul√©');
                    return;
                }

                const sensorData = {
                    name: name,
                    type: 'IR',
                    status: 'active',
                    position: { lat: e.latlng.lat, lng: e.latlng.lng },
                    timestamp: Date.now(),
                    placedBy: window.appState.playerName,
                    manual: true
                };

                if (window.appState.db) {
                    const sensorRef = ref(window.appState.db, 
                        `sensors/${window.appState.teamCode}/${name}`);
                    set(sensorRef, sensorData).then(() => {
                        console.log('‚úÖ Capteur sauvegard√©');
                        notify('üì° Capteur ' + name + ' ajout√©');
                        panel.classList.add('show');
                    }).catch(err => {
                        console.error('‚ùå Erreur:', err);
                        notify('‚ùå Erreur ajout');
                    });
                }
            };

            window.appState.map.once('click', handler);
        };

        window.testSensorById = function(id) {
            console.log('üîî Test capteur:', id);
            if (window.appState.db) {
                const cmdRef = ref(window.appState.db, 
                    `sensors/${window.appState.teamCode}/${id}/command`);
                set(cmdRef, 'test');
                notify('üîî Test envoy√©');
            }
        };

        window.removeSensorById = function(id) {
            if (!confirm(`Supprimer ${id} ?`)) return;
            
            if (window.appState.db) {
                const sensorRef = ref(window.appState.db, 
                    `sensors/${window.appState.teamCode}/${id}`);
                remove(sensorRef);
                notify('‚úÖ Capteur supprim√©');
            }
        };

        window.testSensor = function() {
            notify('üîî Test de tous les capteurs...');
            Object.keys(window.appState.sensors).forEach(id => {
                testSensorById(id);
            });
        };

        window.centerMap = function() {
            if (window.appState.map) {
                window.appState.map.setView(
                    [window.appState.position.lat, window.appState.position.lng], 
                    15
                );
                notify('üìç Carte centr√©e');
            }
        };

        window.showDebug = function() {
            console.log('=== DEBUG STATE ===');
            console.log('Team:', window.appState.teamCode);
            console.log('Player:', window.appState.playerName);
            console.log('Connected:', window.appState.isConnected);
            console.log('Sensors:', window.appState.sensors);
            console.log('Map:', window.appState.map);
            
            alert(`DEBUG\n\n√âquipe: ${window.appState.teamCode}\nJoueur: ${window.appState.playerName}\nConnexion: ${window.appState.isConnected ? 'OK' : 'OFF'}\nCapteurs: ${Object.keys(window.appState.sensors).length}\n\nVoir console (F12) pour d√©tails`);
        };

        function notify(message) {
            console.log('üì¢', message);
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        console.log('‚úÖ Script charg√© - Pr√™t √† d√©marrer');
    </script>
</body>
</html>
